<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Details - Expense Tracker</title>
    <link rel="stylesheet" href="/styles/sidebar.css">
    <link rel="stylesheet" href="/styles/expenses.css">
    <style>
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .trip-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .trip-info h2 {
            margin-top: 0;
            color: #333;
        }

        .trip-info .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            font-size: 1em;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-finished {
            background: #d1ecf1;
            color: #0c5460;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .action-cell {
            width: 100px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal h3 {
            margin-top: 0;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close-modal:hover {
            color: #000;
        }

        .message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <%- include('partials/sidebar') %>

    <div class="container">
        <div id="messageContainer"></div>

        <!-- Trip Information -->
        <div class="trip-info">
            <h2>Trip Details</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Trip Name</span>
                    <span class="info-value" id="tripName">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Travel Type</span>
                    <span class="info-value" id="travelType">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">From Date</span>
                    <span class="info-value" id="fromDate">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">To Date</span>
                    <span class="info-value" id="toDate">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="info-value" id="tripStatus">-</span>
                </div>
            </div>
        </div>

        <!-- Expenses Section -->
        <div class="section">
            <h3>Expenses</h3>
            <div class="action-bar" id="expenseActions">
                <button class="btn btn-success" onclick="approveSelectedExpenses()" id="approveExpenseBtn">
                    Approve Selected
                </button>
                <button class="btn btn-danger" onclick="showExpenseModal()">
                    Reject Single
                </button>
                <button class="btn btn-primary" onclick="finishTripAction()" id="finishTripBtn">
                    Mark Trip as Finished
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAllExpenses" onchange="toggleAllExpenses()">
                        </th>
                        <th>Expense Title</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Receipts</th>
                        <th class="action-cell">Action</th>
                    </tr>
                </thead>
                <tbody id="expensesTable">
                    <tr>
                        <td colspan="9" class="no-data">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Advances Section -->
        <div class="section">
            <h3>Advances</h3>
            <div class="action-bar" id="advanceActions">
                <button class="btn btn-success" onclick="approveSelectedAdvances()" id="approveAdvanceBtn">
                    Approve Selected
                </button>
                <button class="btn btn-danger" onclick="showAdvanceModal()">
                    Reject Single
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAllAdvances" onchange="toggleAllAdvances()">
                        </th>
                        <th>Paid Through</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Reference ID</th>
                        <th>Notes</th>
                        <th>Status</th>
                        <th class="action-cell">Action</th>
                    </tr>
                </thead>
                <tbody id="advancesTable">
                    <tr>
                        <td colspan="7" class="no-data">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Rejection Modal for Expenses -->
    <div id="expenseRejectModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeExpenseModal()">&times;</span>
            <h3>Reject Expense</h3>
            <div class="form-group">
                <label for="expenseRejectReason">Rejection Reason *</label>
                <textarea id="expenseRejectReason" placeholder="Please provide a reason for rejection..." required></textarea>
            </div>
            <input type="hidden" id="rejectExpenseId">
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="rejectExpense()">Reject</button>
                <button class="btn" onclick="closeExpenseModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal for Advances -->
    <div id="advanceRejectModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAdvanceModal()">&times;</span>
            <h3>Reject Advance</h3>
            <div class="form-group">
                <label for="advanceRejectReason">Rejection Reason *</label>
                <textarea id="advanceRejectReason" placeholder="Please provide a reason for rejection..." required></textarea>
            </div>
            <input type="hidden" id="rejectAdvanceId">
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="rejectAdvance()">Reject</button>
                <button class="btn" onclick="closeAdvanceModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const tripId = <%= tripId %>;
        let tripData = null;

        // Load trip details on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTripDetails();
        });

        async function loadTripDetails() {
            try {
                const response = await fetch(`/ajax/trip-details/${tripId}`);
                const data = await response.json();
                
                tripData = data;
                displayTripInfo(data.trip);
                displayExpenses(data.expenses);
                displayAdvances(data.advances);
                updateActionButtons(data.trip.status);
            } catch (error) {
                console.error('Error loading trip details:', error);
                showMessage('Error loading trip details', 'error');
            }
        }

        function displayTripInfo(trip) {
            document.getElementById('tripName').textContent = trip.trip_name;
            document.getElementById('travelType').textContent = trip.travel_type;
            document.getElementById('fromDate').textContent = new Date(trip.from_date).toLocaleDateString();
            document.getElementById('toDate').textContent = new Date(trip.to_date).toLocaleDateString();
            
            const statusBadge = `<span class="status-badge status-${trip.status}">${trip.status.toUpperCase()}</span>`;
            document.getElementById('tripStatus').innerHTML = statusBadge;
        }

        function displayExpenses(expenses) {
            const tbody = document.getElementById('expensesTable');
            
            if (!expenses || expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">No expenses found for this trip</td></tr>';
                return;
            }

            tbody.innerHTML = expenses.map(expense => `
                <tr>
                    <td class="checkbox-cell">
                        ${expense.status === 'pending' ? `<input type="checkbox" class="expense-checkbox" value="${expense.id}">` : ''}
                    </td>
                    <td>${expense.expense_title}</td>
                    <td>${expense.category_name || '-'}</td>
                    <td>₹${parseFloat(expense.amount).toFixed(2)}</td>
                    <td>${expense.currency}</td>
                    <td>${new Date(expense.date).toLocaleDateString()}</td>
                    <td>${expense.description || '-'}</td>
                    <td><span class="status-badge status-${expense.status}">${expense.status.toUpperCase()}</span></td>
                    <td>${expense.receipt_count > 0 ? expense.receipt_count + ' file(s)' : '-'}</td>
                    <td class="action-cell">
                        ${expense.status === 'pending' ? `<button class="btn btn-danger" onclick="openExpenseRejectModal(${expense.id})">Reject</button>` : (expense.rejection_reason ? '<span title="' + expense.rejection_reason + '">Rejected</span>' : '-')}
                    </td>
                </tr>
            `).join('');
        }

        function displayAdvances(advances) {
            const tbody = document.getElementById('advancesTable');
            
            if (!advances || advances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No advances found for this trip</td></tr>';
                return;
            }

            tbody.innerHTML = advances.map(advance => `
                <tr>
                    <td class="checkbox-cell">
                        ${advance.status === 'pending' ? `<input type="checkbox" class="advance-checkbox" value="${advance.id}">` : ''}
                    </td>
                    <td>${advance.paid_through}</td>
                    <td>₹${parseFloat(advance.amount).toFixed(2)}</td>
                    <td>${advance.currency}</td>
                    <td>${advance.reference_id || '-'}</td>
                    <td>${advance.notes || '-'}</td>
                    <td><span class="status-badge status-${advance.status}">${advance.status.toUpperCase()}</span></td>
                    <td class="action-cell">
                        ${advance.status === 'pending' ? `<button class="btn btn-danger" onclick="openAdvanceRejectModal(${advance.id})">Reject</button>` : (advance.rejection_reason ? '<span title="' + advance.rejection_reason + '">Rejected</span>' : '-')}
                    </td>
                </tr>
            `).join('');
        }

        function updateActionButtons(status) {
            const isFinished = status === 'finished';
            const isPending = status === 'pending';
            
            document.getElementById('approveExpenseBtn').disabled = isFinished || isPending;
            document.getElementById('approveAdvanceBtn').disabled = isFinished || isPending;
            document.getElementById('finishTripBtn').disabled = isFinished || isPending;
            document.getElementById('finishTripBtn').textContent = isFinished ? 'Trip Finished' : 'Mark Trip as Finished';
        }

        function toggleAllExpenses() {
            const checked = document.getElementById('selectAllExpenses').checked;
            document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = checked);
        }

        function toggleAllAdvances() {
            const checked = document.getElementById('selectAllAdvances').checked;
            document.querySelectorAll('.advance-checkbox').forEach(cb => cb.checked = checked);
        }

        async function approveSelectedExpenses() {
            const checkboxes = document.querySelectorAll('.expense-checkbox:checked');
            const expenseIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (expenseIds.length === 0) {
                showMessage('Please select at least one expense', 'error');
                return;
            }

            try {
                const response = await fetch('/ajax/approve-expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ expenseIds })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadTripDetails();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error approving expenses:', error);
                showMessage('Error approving expenses', 'error');
            }
        }

        async function approveSelectedAdvances() {
            const checkboxes = document.querySelectorAll('.advance-checkbox:checked');
            const advanceIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (advanceIds.length === 0) {
                showMessage('Please select at least one advance', 'error');
                return;
            }

            try {
                const response = await fetch('/ajax/approve-advances', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ advanceIds })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadTripDetails();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error approving advances:', error);
                showMessage('Error approving advances', 'error');
            }
        }

        function openExpenseRejectModal(expenseId) {
            document.getElementById('rejectExpenseId').value = expenseId;
            document.getElementById('expenseRejectReason').value = '';
            document.getElementById('expenseRejectModal').style.display = 'block';
        }

        function closeExpenseModal() {
            document.getElementById('expenseRejectModal').style.display = 'none';
        }

        function showExpenseModal() {
            showMessage('Please use the Reject button next to individual expenses', 'error');
        }

        async function rejectExpense() {
            const expenseId = document.getElementById('rejectExpenseId').value;
            const rejectionReason = document.getElementById('expenseRejectReason').value.trim();

            if (!rejectionReason) {
                showMessage('Please provide a rejection reason', 'error');
                return;
            }

            try {
                const response = await fetch('/ajax/reject-expense', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ expenseId: parseInt(expenseId), rejectionReason })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeExpenseModal();
                    loadTripDetails();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error rejecting expense:', error);
                showMessage('Error rejecting expense', 'error');
            }
        }

        function openAdvanceRejectModal(advanceId) {
            document.getElementById('rejectAdvanceId').value = advanceId;
            document.getElementById('advanceRejectReason').value = '';
            document.getElementById('advanceRejectModal').style.display = 'block';
        }

        function closeAdvanceModal() {
            document.getElementById('advanceRejectModal').style.display = 'none';
        }

        function showAdvanceModal() {
            showMessage('Please use the Reject button next to individual advances', 'error');
        }

        async function rejectAdvance() {
            const advanceId = document.getElementById('rejectAdvanceId').value;
            const rejectionReason = document.getElementById('advanceRejectReason').value.trim();

            if (!rejectionReason) {
                showMessage('Please provide a rejection reason', 'error');
                return;
            }

            try {
                const response = await fetch('/ajax/reject-advance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ advanceId: parseInt(advanceId), rejectionReason })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeAdvanceModal();
                    loadTripDetails();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error rejecting advance:', error);
                showMessage('Error rejecting advance', 'error');
            }
        }

        async function finishTripAction() {
            if (!confirm('Are you sure you want to mark this trip as finished? No more expenses or advances can be added after this.')) {
                return;
            }

            try {
                const response = await fetch('/ajax/finish-trip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tripId })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadTripDetails();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error finishing trip:', error);
                showMessage('Error finishing trip', 'error');
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const expenseModal = document.getElementById('expenseRejectModal');
            const advanceModal = document.getElementById('advanceRejectModal');
            if (event.target === expenseModal) {
                closeExpenseModal();
            }
            if (event.target === advanceModal) {
                closeAdvanceModal();
            }
        }
    </script>
</body>
</html>
