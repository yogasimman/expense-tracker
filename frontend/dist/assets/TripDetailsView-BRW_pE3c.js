import{u as te,q as se,c as n,a as t,p as x,l as f,t as o,d,b as c,n as B,F as E,j as M,f as y,s as ae,r as v,m as F,h as ne,g as le,o as l,e as ie,v as oe}from"./index-BFw-5ybC.js";import{u as re}from"./trips-6R3CgoW9.js";import{u as ue}from"./expenses-68LlJUI8.js";import{u as de}from"./advances-Bs1wD2gA.js";import{u as ce}from"./useToast-s_LeXPXK.js";import{P as ve}from"./PageHeader-BOipoClw.js";import{S as N}from"./StatusBadge-HXGXxIt_.js";import{D as U}from"./DataTable-Bv1DpfSK.js";import{B as be}from"./BaseModal-BqmQ-p03.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me={key:0,class:"loading-center"},fe={key:1},ye={key:2},ge={class:"card mb-4"},ke={class:"card-body"},xe={class:"trip-info-grid"},_e={class:"info-value capitalize"},he={class:"info-value"},Ae={key:0},Ce={class:"info-value"},Te={key:1},we={class:"info-value"},je={key:0,class:"card mb-4"},Se={key:0,class:"card-body"},De={class:"section-label"},Ee={class:"text-muted text-sm"},Ne={class:"text-muted text-sm"},Re={class:"card mb-4"},Ie={class:"card-header"},Fe={class:"card-title"},Ve={class:"card-body card-body-flush"},$e=["onClick"],Le=["onClick"],Be={key:1,class:"bulk-actions"},Me={class:"bulk-count"},Ue={class:"card mb-4"},ze={class:"card-header"},Pe={class:"card-title"},Oe={class:"card-body card-body-flush"},qe=["onClick"],He=["onClick"],Ge={key:2,class:"bulk-actions bulk-actions-advance"},Je={class:"bulk-count"},Ke={key:3,class:"finish-section card"},Qe={class:"card-body d-flex-center gap-3"},We=["disabled"],Xe={class:"form-group"},Ye=["disabled"],Ze={__name:"TripDetailsView",setup(et){const z=ne();le();const b=te(),P=re(),C=ue(),T=de(),u=ce(),V=v(!0),i=v(null),A=v(null),w=v([]),j=v([]),g=v([]),k=v([]),S=v(!1),h=v(!1),p=v(""),R=v(null),O=[{key:"title",label:"Title",sortable:!0},{key:"amount",label:"Amount",sortable:!0},{key:"category",label:"Category"},{key:"status",label:"Status",sortable:!0},{key:"expense_date",label:"Date",type:"date"}],q=[{key:"amount",label:"Amount",sortable:!0},{key:"paid_through",label:"Paid Through"},{key:"reference",label:"Reference"},{key:"status",label:"Status",sortable:!0}],H=F(()=>{var e,s,r,m,D;if(!((e=i.value)!=null&&e.itinerary))return!1;const a=i.value.itinerary;return((s=a.flights)==null?void 0:s.length)||((r=a.buses)==null?void 0:r.length)||((m=a.trains)==null?void 0:m.length)||((D=a.cabs)==null?void 0:D.length)}),G=F(()=>{var e;if(!((e=i.value)!=null&&e.itinerary))return{};const a={};for(const[s,r]of Object.entries(i.value.itinerary))r&&r.length&&(a[s]=r);return a}),J=F(()=>{const a=w.value.every(s=>s.status!=="pending"),e=j.value.every(s=>s.status!=="pending");return a&&e});function I(a){return a?new Date(a).toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"}):"-"}function K(a){return{flights:"bi bi-airplane",buses:"bi bi-bus-front",trains:"bi bi-train-front",cabs:"bi bi-taxi-front"}[a]||"bi bi-geo"}function $(a,e){R.value={type:a,item:e,bulk:!1},p.value="",h.value=!0}function L(a){R.value={type:a,bulk:!0},p.value="",h.value=!0}async function Q(){const a=R.value;try{if(a.type==="expense")if(a.bulk){for(const e of g.value)await C.rejectExpense(e.id,p.value);g.value=[]}else await C.rejectExpense(a.item.id,p.value);else if(a.bulk){for(const e of k.value)await T.rejectAdvance(e.id,p.value);k.value=[]}else await T.rejectAdvance(a.item.id,p.value);h.value=!1,u.success("Rejected successfully"),await _()}catch(e){u.error(e.message)}}async function W(){try{await C.approveExpenses(g.value.map(a=>a.id)),g.value=[],u.success("Expenses approved"),await _()}catch(a){u.error(a.message)}}async function X(){try{await T.approveAdvances(k.value.map(a=>a.id)),k.value=[],u.success("Advances approved"),await _()}catch(a){u.error(a.message)}}async function Y(a){if(confirm("Delete this expense?"))try{await C.deleteExpense(a.id),u.success("Expense deleted"),await _()}catch(e){u.error(e.message)}}async function Z(a){if(confirm("Delete this advance?"))try{await T.deleteAdvance(a.id),u.success("Advance deleted"),await _()}catch(e){u.error(e.message)}}async function ee(){try{await P.finishTrip(i.value.id),u.success("Trip finished"),await _()}catch(a){u.error(a.message)}}async function _(){const a=z.params.id;try{const e=await ae.getTrip(a);i.value=e.trip||e,A.value=e.stats||null,w.value=e.expenses||[],j.value=e.advances||[]}catch(e){console.error(e)}}return se(async()=>{await _(),V.value=!1}),(a,e)=>V.value?(l(),n("div",me,[...e[8]||(e[8]=[t("div",{class:"loading-spinner"},null,-1)])])):i.value?(l(),n("div",ye,[x(ve,{title:i.value.tripName||i.value.trip_name,icon:"bi bi-airplane-fill",subtitle:`${i.value.travelType||i.value.travel_type} trip`},{default:f(()=>[x(N,{status:i.value.status},null,8,["status"])]),_:1},8,["title","subtitle"]),t("div",ge,[t("div",ke,[t("div",xe,[t("div",null,[e[10]||(e[10]=t("span",{class:"info-label"},"Type",-1)),t("span",_e,o(i.value.travelType||i.value.travel_type),1)]),t("div",null,[e[11]||(e[11]=t("span",{class:"info-label"},"Status",-1)),x(N,{status:i.value.status},null,8,["status"])]),t("div",null,[e[12]||(e[12]=t("span",{class:"info-label"},"Created",-1)),t("span",he,o(I(i.value.created_at)),1)]),A.value?(l(),n("div",Ae,[e[13]||(e[13]=t("span",{class:"info-label"},"Total Expense",-1)),t("span",Ce,"₹"+o(Number(A.value.total_expense_amount||0).toLocaleString("en-IN")),1)])):d("",!0),A.value?(l(),n("div",Te,[e[14]||(e[14]=t("span",{class:"info-label"},"Total Advance",-1)),t("span",we,"₹"+o(Number(A.value.total_advance_amount||0).toLocaleString("en-IN")),1)])):d("",!0)])])]),H.value?(l(),n("div",je,[t("div",{class:"card-header cursor-pointer",onClick:e[0]||(e[0]=s=>S.value=!S.value)},[e[15]||(e[15]=t("span",{class:"card-title"},[t("i",{class:"bi bi-map me-2"}),c("Itinerary")],-1)),t("i",{class:B(S.value?"bi bi-chevron-up":"bi bi-chevron-down")},null,2)]),S.value?(l(),n("div",Se,[(l(!0),n(E,null,M(G.value,(s,r)=>(l(),n("div",{key:r,class:"itinerary-section"},[t("h4",De,[t("i",{class:B(K(r))},null,2),c(" "+o(r),1)]),(l(!0),n(E,null,M(s,(m,D)=>(l(),n("div",{key:D,class:"itinerary-item"},[r==="cabs"?(l(),n(E,{key:0},[t("span",null,o(m.pickUpLocation)+" → "+o(m.dropOffLocation),1),t("span",Ee,o(I(m.pickUpDate)),1)],64)):(l(),n(E,{key:1},[t("span",null,o(m.departFrom)+" → "+o(m.arriveAt),1),t("span",Ne,o(I(m.departureDate)),1)],64))]))),128))]))),128))])):d("",!0)])):d("",!0),t("div",Re,[t("div",Ie,[t("span",Fe,[e[16]||(e[16]=t("i",{class:"bi bi-receipt me-2"},null,-1)),c("Expenses ("+o(w.value.length)+")",1)])]),t("div",Ve,[x(U,{columns:O,data:w.value,selectable:y(b).isAdmin&&i.value.status!=="finished",selectableFilter:s=>s.status==="pending",selected:g.value,"onUpdate:selected":e[1]||(e[1]=s=>g.value=s)},{"cell-status":f(({value:s})=>[x(N,{status:s},null,8,["status"])]),"cell-amount":f(({row:s})=>[c(" ₹"+o(Number(s.amount).toLocaleString("en-IN")),1)]),actions:f(({row:s})=>[y(b).isAdmin&&s.status==="pending"?(l(),n("button",{key:0,class:"btn btn-ghost btn-sm text-danger",onClick:r=>$("expense",s)},[...e[17]||(e[17]=[t("i",{class:"bi bi-x-circle"},null,-1)])],8,$e)):d("",!0),!y(b).isAdmin&&s.status==="pending"?(l(),n("button",{key:1,class:"btn btn-ghost btn-sm text-danger",onClick:r=>Y(s)},[...e[18]||(e[18]=[t("i",{class:"bi bi-trash"},null,-1)])],8,Le)):d("",!0)]),_:1},8,["data","selectable","selectableFilter","selected"])])]),y(b).isAdmin&&g.value.length?(l(),n("div",Be,[t("span",Me,o(g.value.length)+" expense(s)",1),t("button",{class:"btn btn-success btn-sm",onClick:W},[...e[19]||(e[19]=[t("i",{class:"bi bi-check-lg"},null,-1),c(" Approve",-1)])]),t("button",{class:"btn btn-danger btn-sm",onClick:e[2]||(e[2]=s=>L("expense"))},[...e[20]||(e[20]=[t("i",{class:"bi bi-x-lg"},null,-1),c(" Reject",-1)])])])):d("",!0),t("div",Ue,[t("div",ze,[t("span",Pe,[e[21]||(e[21]=t("i",{class:"bi bi-credit-card me-2"},null,-1)),c("Advances ("+o(j.value.length)+")",1)])]),t("div",Oe,[x(U,{columns:q,data:j.value,selectable:y(b).isAdmin&&i.value.status!=="finished",selectableFilter:s=>s.status==="pending",selected:k.value,"onUpdate:selected":e[3]||(e[3]=s=>k.value=s)},{"cell-status":f(({value:s})=>[x(N,{status:s},null,8,["status"])]),"cell-amount":f(({row:s})=>[c(" ₹"+o(Number(s.amount).toLocaleString("en-IN")),1)]),actions:f(({row:s})=>[y(b).isAdmin&&s.status==="pending"?(l(),n("button",{key:0,class:"btn btn-ghost btn-sm text-danger",onClick:r=>$("advance",s)},[...e[22]||(e[22]=[t("i",{class:"bi bi-x-circle"},null,-1)])],8,qe)):d("",!0),!y(b).isAdmin&&s.status==="pending"?(l(),n("button",{key:1,class:"btn btn-ghost btn-sm text-danger",onClick:r=>Z(s)},[...e[23]||(e[23]=[t("i",{class:"bi bi-trash"},null,-1)])],8,He)):d("",!0)]),_:1},8,["data","selectable","selectableFilter","selected"])])]),y(b).isAdmin&&k.value.length?(l(),n("div",Ge,[t("span",Je,o(k.value.length)+" advance(s)",1),t("button",{class:"btn btn-success btn-sm",onClick:X},[...e[24]||(e[24]=[t("i",{class:"bi bi-check-lg"},null,-1),c(" Approve",-1)])]),t("button",{class:"btn btn-danger btn-sm",onClick:e[4]||(e[4]=s=>L("advance"))},[...e[25]||(e[25]=[t("i",{class:"bi bi-x-lg"},null,-1),c(" Reject",-1)])])])):d("",!0),y(b).isAdmin&&i.value.status==="approved"?(l(),n("div",Ke,[t("div",Qe,[e[27]||(e[27]=t("p",{class:"text-muted"},"All expenses and advances must be approved/rejected before finishing.",-1)),t("button",{class:"btn btn-primary",disabled:!J.value,onClick:ee},[...e[26]||(e[26]=[t("i",{class:"bi bi-check2-all"},null,-1),c(" Finish Trip ",-1)])],8,We)])])):d("",!0),x(be,{modelValue:h.value,"onUpdate:modelValue":e[7]||(e[7]=s=>h.value=s),title:"Reject Item",size:"sm"},{footer:f(()=>[t("button",{class:"btn btn-outline",onClick:e[6]||(e[6]=s=>h.value=!1)},"Cancel"),t("button",{class:"btn btn-danger",onClick:Q,disabled:!p.value.trim()},"Reject",8,Ye)]),default:f(()=>[t("div",Xe,[e[28]||(e[28]=t("label",{class:"form-label"},"Reason for rejection",-1)),ie(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>p.value=s),class:"form-input",rows:"3",placeholder:"Enter reason..."},null,512),[[oe,p.value]])])]),_:1},8,["modelValue"])])):(l(),n("div",fe,[...e[9]||(e[9]=[t("div",{class:"empty-state"},[t("p",null,"Trip not found")],-1)])]))}},ct=pe(Ze,[["__scopeId","data-v-bd2cb139"]]);export{ct as default};
